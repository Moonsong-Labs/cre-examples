name: CI

on:
  push:
    branches: [master]
  pull_request:

env:
  FOUNDRY_PROFILE: ci

jobs:
  biome-format:
    name: Biome Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Check formatting
        run: bunx biome format --check .

  biome-lint:
    name: Biome Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Lint
        run: bunx biome lint .

  biome-imports:
    name: Biome Imports
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Check import sorting
        run: bunx biome check --linter-enabled=false --formatter-enabled=false .

  fe-typecheck:
    name: Frontend Typecheck
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: fe
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Panda codegen
        run: bun run prepare

      - name: Typecheck
        run: bun run typecheck

  fe-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: fe
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Panda codegen
        run: bun run prepare

      - name: Build
        run: bun run build

  forge-build:
    name: Forge Build (${{ matrix.example }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        example:
          - 01-cross-chain-relayer
    defaults:
      run:
        working-directory: examples/${{ matrix.example }}/contracts
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: stable

      - name: Install soldeer dependencies
        run: forge soldeer install

      - name: Build contracts
        run: forge build --sizes

  forge-fmt:
    name: Forge Format (${{ matrix.example }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        example:
          - 01-cross-chain-relayer
    defaults:
      run:
        working-directory: examples/${{ matrix.example }}/contracts
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: stable

      - name: Install soldeer dependencies
        run: forge soldeer install

      - name: Check formatting
        run: forge fmt --check

  forge-test:
    name: Forge Test (${{ matrix.example }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        example:
          - 01-cross-chain-relayer
    defaults:
      run:
        working-directory: examples/${{ matrix.example }}/contracts
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: stable

      - name: Install soldeer dependencies
        run: forge soldeer install

      - name: Run tests
        run: forge test -vvv
        continue-on-error: true

  # cre-simulate:
  #   name: CRE Simulate (${{ matrix.example }})
  #   runs-on: ubuntu-latest
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       example:
  #         - 01-cross-chain-relayer
  #   defaults:
  #     run:
  #       working-directory: examples/${{ matrix.example }}
  #   steps:
  #     - uses: actions/checkout@v4

  #     - uses: oven-sh/setup-bun@v2
  #       with:
  #         bun-version: latest

  #     - name: Install CRE CLI
  #       run: |
  #         curl -sSL https://cre.chain.link/install.sh | bash
  #         echo "$HOME/.cre" >> $GITHUB_PATH

  #     - name: Install dependencies
  #       run: bun install

  #     - name: Run CRE simulation
  #       run: bun run simulate
  #       env:
  #         ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
